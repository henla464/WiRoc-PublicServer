<!DOCTYPE html>
<html lang="en">
  <head>
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="manifest" href="/site.webmanifest" />

    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link
      href="libs/TableSorter/css/theme.bootstrap_4.min.css"
      rel="stylesheet"
      crossorigin="anonymous"
    />

    <!-- Bootstrap CSS -->
    <link
      href="libs/bootstrap-5.0.2-dist/css/bootstrap.min.css"
      rel="stylesheet"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"
    />
    <link rel="stylesheet" href="ui/css/wiroc.css" />

    <title>WiRoc Monitor</title>
  </head>
  <body>
    <div
      id="itemCreatedAlert"
      class="alert alert-success alert-dismissible collapse"
      style="margin-bottom: 0"
      role="alert"
    >
      <strong>The -- was created!</strong>
      <button type="button" class="btn-close close" aria-label="Close"></button>
    </div>
    <div
      id="itemUpdatedAlert"
      class="alert alert-success alert-dismissible collapse"
      style="margin-bottom: 0"
      role="alert"
    >
      <strong>The device was added to competition!</strong>
      <button type="button" class="btn-close close" aria-label="Close"></button>
    </div>

    <div id="nav-placeholder"></div>
    <div class="container-fluid gx-2">
      <h1><span id="deviceName">WiRoc Device</span><button
        class="btn fa fa-pencil edititem"
        data-bs-toggle="modal"
        data-bs-target="#editdevice"
      ></button></h1>
      <h4 id="deviceBTAddress">()</h4>
      Competition: <span id="competitionName"></span>
      <br />
      WiRoc HW version: <span id="hwVersion"></span>
      <br />
      WiRoc version: <span id="wirocPythongVersion"></span>
      <br />
      WiRoc BLE version: <span id="wirocBLEVersion"></span>
      <br />
      Battery:
      <i
        class="fa fa-exclamation-triangle"
        style="display: none"
        id="batteryIsLowWarning"
      >
        Battery is LOW!</i
      >&nbsp;<span id="batteryIsLowWarningTime"></span>&nbsp;&nbsp;<span
        id="deviceBattery"
      ></span>
      <br />
      Control numbers: <span id="deviceSIStationNumber"></span>
      <br />
      Remote WiRoc devices: <span id="remoteDevices"></span>
      <span
        id="remoteDeviceBatteryLowWarning"
        style="display: none; background-color: red"
        >Battery low at remote device</span
      >
      <span id="remoteDeviceBatteryLowWarningTime"></span>
      <br />
      Connected USB devices: <span id="connectedDevices"></span>
      <br />
      Internal SRR: <span id="internalSRRs"></span>
      <br />
      <div style="min-height: 400px">
        <canvas id="batteryChart"></canvas>
      </div>

      <button
        type="button"
        id="btnDeleteMessageStats"
        class="btn btn-secondary small"
        style="display: none"
      >
        Delete message statistics for this device
      </button>
      <br /><br />
    </div>

    <div class="d-flex flex-wrap">
      <div class="container col-md-6 gx-2">
        <h2>Number of messages received</h2>
        <div class="table-responsive">
          <table
            class="table table-striped table-hover table-sm"
            id="ReceivedMessagesAggregated"
          >
            <caption></caption>
            <thead>
              <tr>
                <th scope="col">Adapter instance</th>
                <th scope="col">Message type</th>
                <th scope="col">Number of messages</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="container col-md-6 gx-2">
        <h2>Number of messages sent</h2>
        <div class="table-responsive">
          <table
            class="table table-striped table-hover table-sm"
            id="SentMessagesAggregated"
          >
            <caption></caption>
            <thead>
              <tr>
                <th scope="col">Adapter instance</th>
                <th scope="col">Message type</th>
                <th scope="col">Number of messages</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="container col-md-6 gx-2">
        <h2>Messages received</h2>
        <div class="table-responsive">
          <table
            class="table table-striped table-hover table-sm"
            id="ReceivedMessages"
          >
            <caption></caption>
            <thead>
              <tr>
                <th scope="col">Adapter instance</th>
                <th scope="col">Message type</th>
                <th scope="col">Date/time</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="container col-md-6 gx-2">
        <h2>Messages sent</h2>
        <div class="table-responsive">
          <table
            class="table table-striped table-hover table-sm"
            id="SentMessages"
          >
            <caption></caption>
            <thead>
              <tr>
                <th scope="col">Adapter instance</th>
                <th scope="col">Message type</th>
                <th scope="col">Date/time</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div id="signup-modal-placeholder"></div>
      <div id="addnewitem-modal-placeholder"></div>

      <!-- Optional JavaScript; choose one of the two! -->
      <script src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
      <!-- Option 1: Bootstrap Bundle with Popper -->
      <script
        src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
        crossorigin="anonymous"
      ></script>
      <script
        src="libs/TableFilter/TableFilter.js"
        type="text/javascript"
      ></script>
      <script
        src="libs/TableSorter/js/jquery.tablesorter.min.js"
        type="text/javascript"
      ></script>
      <script
        src="libs/TableSorter/js/jquery.tablesorter.widgets.min.js"
        type="text/javascript"
      ></script>

      <!-- Option 2: Separate Popper and Bootstrap JS -->
      <!--
      <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.2/dist/umd/popper.min.js" integrity="sha384-7+zCNj/IqJ95wo16oMtfsKbZ9ccEh31eOz1HGyDuCQ6wgnyJNSYdrPa03rtR1zdB" crossorigin="anonymous"></script>
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js" integrity="sha384-QJHtvGhmr9XOIpI6YVutG+2QOK9T+ZnN4kzFN1RtK3zEFEIsxhlmWl5/YESvpZ13" crossorigin="anonymous"></script>
      -->
      <script
        src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.3.2/chart.umd.js"
        integrity="sha512-KIq/d78rZMlPa/mMe2W/QkRgg+l0/GAAu4mGBacU0OQyPV/7EPoGQChDb269GigVoPQit5CqbNRFbgTjXHHrQg=="
        crossorigin="anonymous"
        referrerpolicy="no-referrer"
      ></script>
      <!--    <script src="https://cdn.jsdelivr.net/npm/luxon@^2"></script>
      <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@^1"></script>-->
      <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
      <script>
        $.urlParam = function (name) {
          var results = new RegExp("[\?&]" + name + "=([^&#]*)").exec(
            window.location.search
          );

          return results !== null ? results[1] || 0 : false;
        };

        var btAddressOfDevice = $.urlParam("devicebt");
        var modalHtmlFileName = "editdevicemodal.html";
        var competitionTableName = "Competitions";
        var tableName = "Devices";

        function loadBatteryChart(latestStatuses) {
          // Battery chart
          //let minCreateDate = Math.min.apply(null, latestStatuses.map(function (s) { return s.createdTime; }));
          const minCreateDateStatusObj = latestStatuses.reduce((acc, loc) =>
            acc.createdTime < loc.createdTime ? acc : loc
          );
          let minCreateDateTimeStr = minCreateDateStatusObj.createdTime;

          const ctx = document.getElementById("batteryChart");
          // Only destroy if the chart exists and is a Chart.js instance
          if (ctx.chart) {
            ctx.chart.destroy();
          }

          let todayDateTime = new Date();
          const yesterdayDateTime = new Date();
          yesterdayDateTime.setDate(yesterdayDateTime.getDate() - 1);
          yesterdayDateOnly = new Date(yesterdayDateTime.toDateString());

          const tomorrow = new Date();
          tomorrow.setDate(tomorrow.getDate() - 1);
          tomorrowDateOnly = new Date(tomorrow.toDateString());

          let todayDateOnly = new Date(todayDateTime.toDateString());

          var maxDateTime = new Date();

          var minDateTimeStr = "";
          var minCreateDateTime = new Date(minCreateDateTimeStr);
          if (yesterdayDateTime > minCreateDateTime) {
            minDateTimeStr = yesterdayDateTime.toLocaleString("sv-SE");
            maxDateTime.setHours(todayDateTime.getHours() + 1);
          } else {
            minDateTimeStr = minCreateDateTimeStr;
            maxDateTime = new Date(minCreateDateTimeStr);
            console.log(maxDateTime.toLocaleString("sv-SE"));
            maxDateTime.setDate(new Date(minCreateDateTimeStr).getDate() + 1);
          }
          let maxDateTimeStr = maxDateTime.toLocaleString("sv-SE").slice(0, 23);

          console.log(minCreateDateTimeStr);
          console.log(minDateTimeStr);
          console.log(maxDateTimeStr);
          console.log(yesterdayDateOnly), console.log(todayDateOnly);

          // Convert boolean status to numeric (1=true, 0=false)
          const anyPunchNotAcked = latestStatuses.map((s) => ({
            x: s.createdTime,
            y: s.allLoraPunchesSentOK == 0 ? 1 : 0,
          }));
          console.log(latestStatuses[0].allLoraPunchesSentOK);

          const data = {
            labels: [yesterdayDateOnly, todayDateOnly, tomorrowDateOnly],
            datasets: [
              {
                label: "Battery Level",
                data: latestStatuses,
                borderColor: "#00FF00", // Green for battery
                backgroundColor: "#00FF00",
                fill: false,
                cubicInterpolationMode: "monotone",
                tension: 0.4,
                parsing: {
                  xAxisKey: "createdTime",
                  yAxisKey: "batteryLevel",
                },
                yAxisID: "y",
              },
              {
                label: "Unacknowledged LoRa Messages",
                data: latestStatuses,
                borderColor: "#FFA500", // Red for unacknowledged messages
                backgroundColor: "#FFA500",
                fill: false,
                cubicInterpolationMode: "monotone",
                tension: 0.4,
                parsing: {
                  xAxisKey: "createdTime",
                  yAxisKey: "noOfLoraMsgSentNotAcked",
                },
                yAxisID: "y1",
              },
              // Boolean status (blue)
              {
                label: "Any unacknowledged punches",
                data: anyPunchNotAcked,
                borderColor: "#FF0000",
                backgroundColor: "#FF0000",
                borderWidth: 2,
                pointRadius: 5,
                pointHoverRadius: 7,
                parsing: {
                  xAxisKey: "x",
                  yAxisKey: "y",
                },
                yAxisID: "y2",
                // Customize the appearance to make booleans clear
                fill: true,
                stepped: true, // Makes abrupt changes between 0 and 1
                tension: 0, // No smoothing for boolean values
              },
            ],
          };

          const configBatteryChart = {
            type: "line",
            data: data,
            options: {
              maintainAspectRatio: false,
              parsing: {
                xAxisKey: "createdTime",
                yAxisKey: "batteryLevel",
              },
              responsive: true,
              plugins: {
                title: {
                  display: true,
                  text: "Battery Level / Unacknowledged LoRa Messages / Any Unacknowledged Punches",
                },
                tooltip: {
                  callbacks: {
                    label: function (context) {
                      let label = context.dataset.label || "";
                      if (context.datasetIndex === 0) {
                        return label + ": " + context.parsed.y + "%";
                      } else if (context.datasetIndex === 1) {
                        return label + ": " + context.parsed.y;
                      } else {
                        return (
                          label +
                          ": " +
                          (context.parsed.y === 1
                            ? "At least one punch not acked"
                            : "All acked")
                        );
                      }
                    },
                  },
                },
              },
              interaction: {
                intersect: false,
                mode: "index",
              },
              scales: {
                x: {
                  display: true,
                  title: {
                    display: true,
                    text: "Time",
                  },
                  min: minDateTimeStr,
                  max: maxDateTimeStr,
                  type: "time",
                  time: {
                    unit: "hour",
                    unitStepSize: 1,
                    displayFormats: {
                      hour: "HH:mm",
                    },
                  },
                  ticks: {
                    stepSize: 1,
                    major: {
                      enabled: true,
                    },
                    font: (context) => {
                      const boldedTicks =
                        context.tick && context.tick.major ? "bold" : "";
                      return { weight: boldedTicks };
                    },
                  },
                },
                y: {
                  type: "linear",
                  display: true,
                  position: "left",
                  title: {
                    display: true,
                    text: "Battery Percentage",
                  },
                  suggestedMin: 0,
                  suggestedMax: 100,
                  grid: {
                    drawOnChartArea: true,
                  },
                },
                y1: {
                  type: "linear",
                  display: true,
                  position: "right",
                  title: {
                    display: true,
                    text: "Unacknowledged Messages",
                  },
                  suggestedMin: 0,
                  grid: {
                    drawOnChartArea: false,
                  },
                },
                y2: {
                  // Boolean axis (far right)
                  //type: "linear",
                  display: true,
                  position: "right",
                  min: -0,
                  max: 1.1,
                  ticks: {
                    callback: function (value) {
                      // Map numeric values back to text labels
                      if (value === 0) return "No - all good";
                      if (value === 1) return "Yes";
                      return "";
                    },
                    stepSize: 1,
                  },
                  title: { display: true, text: "Unacknowledged punches" },
                  grid: { drawOnChartArea: false },
                },
              },
            },
          };

          new Chart(ctx, configBatteryChart);
        }

        function loadCompetition(compId) {
          $.ajax({
            url: "/api/v1/" + competitionTableName + "/" + compId,
            dataType: "json",
          }).then(function (comp) {
            $("#competitionName").text(comp.name);
          });
        }

        function loadDeviceStatuses() {
          $.ajax({
            url:
              "/api/v1/Devices/" +
              btAddressOfDevice.replaceAll(":", "%3A") +
              "/DeviceStatuses?sort=createdTime desc&limitToCreatedTimeWithinSeconds=86400",
            dataType: "json",
          }).then(function (latestStatuses) {
            if (latestStatuses.length > 0) {
              $("#deviceBattery").text(latestStatuses[0].batteryLevel + "%");
              const uniqueSIStationNumber = [
                ...new Set(latestStatuses.map((stat) => stat.siStationNumber)),
              ];
              var uniqueSIStationNumberString =
                uniqueSIStationNumber.join(", ");
              $("#deviceSIStationNumber").text(uniqueSIStationNumberString);

              var connectedDevicesString = '';
              if (latestStatuses[0].SRRDongleREDFound == '1')
              {
                connectedDevicesString += 'SRR Dongle - RED';
                if (latestStatuses[0].SRRDongleREDAckEnabled)
                {
                  connectedDevicesString += ' (ACK)';
                } else {
                  connectedDevicesString += ' (NO ACK)';
                }
                connectedDevicesString += ' | ';
              }
              if (latestStatuses[0].SRRDongleBLUEFound == '1')
              {
                connectedDevicesString += 'SRR Dongle - BLUE';
                if (latestStatuses[0].SRRDongleBLUEAckEnabled)
                {
                  connectedDevicesString += ' (ACK)';
                } else {
                  connectedDevicesString += ' (NO ACK)';
                }
                connectedDevicesString += ' | ';
              }
              if (latestStatuses[0].siMasterConnectedOnUSB1 == '1')
              {
                connectedDevicesString += 'USB SI Device 1';
                connectedDevicesString += ' | ';
              }
              if (latestStatuses[0].siMasterConnectedOnUSB2 == '1')
              {
                connectedDevicesString += 'USB SI Device 2';
                connectedDevicesString += ' | ';
              }
              if (connectedDevicesString.length > 0)
              {
                connectedDevicesString = connectedDevicesString.substring(0,connectedDevicesString.length - 3);
              }
              $("#connectedDevices").text(connectedDevicesString);

              var internalSRRs = '';
              if (latestStatuses[0].internalSRRREDEnabled == '1')
              {
                internalSRRs += 'SRR RED Enabled';
                if (latestStatuses[0].internalSRRREDDirection == '1')
                {
                  internalSRRs += ' (Sender)';
                } else {
                  if (latestStatuses[0].internalSRRREDAckEnabled)
                  {
                    internalSRRs += ' (ACK)';
                  } else {
                    internalSRRs += ' (NO ACK)';
                  }
                }
                internalSRRs += ' | ';
              }
              if (latestStatuses[0].internalSRRBLUEEnabled == '1')
              {
                internalSRRs += 'SRR BLUE Enabled';
                if (latestStatuses[0].internalSRRBLUEDirection == '1')
                {
                  internalSRRs += ' (Sender)';
                } else {
                  if (latestStatuses[0].internalSRRBLUEAckEnabled)
                  {
                    internalSRRs += ' (ACK)';
                  } else {
                    internalSRRs += ' (NO ACK)';
                  }
                }
                internalSRRs += ' | ';
              }               
              if (internalSRRs.length > 0)
              {
                internalSRRs = internalSRRs.substring(0,internalSRRs.length - 3);
              }
              $("#internalSRRs").text(internalSRRs);
              
              loadBatteryChart(latestStatuses);
            }
          });
        }

        function loadDevice() {
          $.ajax({
            url:
              "/api/v1/" +
              tableName +
              "/" +
              btAddressOfDevice.replaceAll(":", "%3A"),
            dataType: "json",
          }).then(function (device) {
            $("#competitionInput").val(device.competitionId);
            $("#descriptionInput").val(device.description);
            $("#deviceName").text(device.name + "  |  " + device.description);
            $("#deviceBTAddress").text("(" + btAddressOfDevice + ")");
            $("#hwVersion").text(device.hardwareVersion);
            $("#wirocPythongVersion").text(device.wirocPythonVersion);
            $("#wirocBLEVersion").text(device.wirocBLEAPIVersion);
            if (device.batteryIsLow == 1) {
              $("#batteryIsLowWarning").show();
              $("#batteryIsLowWarningTime").text(
                "[" + device.batteryIsLowTime + "]"
              );
              $("#batteryIsLowWarningTime").show();
            } else {
              $("#batteryIsLowWarning").hide();
              $("#batteryIsLowWarningTime").hide();
            }
            if (device.batteryIsLowReceived == 1) {
              $("#remoteDeviceBatteryLowWarning").show();
              $("#remoteDeviceBatteryLowWarningTime").text(
                "[" + device.batteryIsLowReceivedTime + "]"
              );
            } else {
              $("#remoteDeviceBatteryLowWarning").hide();
              $("#remoteDeviceBatteryLowWarningTime").hide();
            }

            loadCompetition(device.competitionId);
            loadDeviceStatuses();
          });
        }

        function loadAggregated() {
          $.ajax({
            url:
              "/api/v1/Devices/" +
              btAddressOfDevice.replaceAll(":", "%3A") +
              "/MessageStats?sort=adapterInstance,messageType&outputType=aggregated",
          }).then(function (data) {
            $("#ReceivedMessagesAggregated tbody").empty();
            $("#SentMessagesAggregated tbody").empty();
            const devices = JSON.parse(data);
            $.each(devices, function () {
              if (this.status == "Received") {
                $("#ReceivedMessagesAggregated tbody").append(
                  "<tr><td>" +
                    this.adapterInstance +
                    "</td><td>" +
                    this.messageType +
                    "</td><td>" +
                    this.noOfMessages +
                    "</td></tr>"
                );
              } else if (this.status == "Sent") {
                $("#SentMessagesAggregated tbody").append(
                  "<tr><td>" +
                    this.adapterInstance +
                    "</td><td>" +
                    this.messageType +
                    "</td><td>" +
                    this.noOfMessages +
                    "</td></tr>"
                );
              }
            });

            $("#ReceivedMessagesAggregated").tablesorter({
              theme: "bootstrap",
            });
            $("#SentMessagesAggregated").tablesorter({ theme: "bootstrap" });

            var tooltip =
              'Quotes (") match phrases. (not) excludes a match from the results. (or) can be used to do Or searches. I.e. [red or blue] will match either red or blue. Numeric values support >=, >, <=, <, = and != operators.';
            // Initialise Plugin
            var optionsbasic = {
              columnFilters: [
                { columnName: "Adapter instance", inputType: "text" },
                { columnName: "Message type", inputType: "text" },
                { columnName: "Number of messages", inputType: "text" },
              ],
              enableCookies: false,
            };

            //$("#ReceivedMessagesAggregated").tableFilter(optionsbasic);
            //$("#SentMessagesAggregated").tableFilter(optionsbasic);
          });
        }

        function loadMessages() {
          $.ajax({
            url:
              "/api/v1/Devices/" +
              btAddressOfDevice.replaceAll(":", "%3A") +
              "/MessageStats?sort=createdTime desc&outputType=normal&limit=200",
          }).then(function (data) {
            $("#ReceivedMessages tbody").empty();
            $("#SentMessages tbody").empty();
            const devices = JSON.parse(data);
            $.each(devices, function () {
              if (this.status == "Received") {
                $("#ReceivedMessages tbody").append(
                  "<tr><td>" +
                    this.adapterInstance +
                    "</td><td>" +
                    this.messageType +
                    "</td><td>" +
                    this.createdTime +
                    "</td></tr>"
                );
              } else if (this.status == "Sent") {
                $("#SentMessages tbody").append(
                  "<tr><td>" +
                    this.adapterInstance +
                    "</td><td>" +
                    this.messageType +
                    "</td><td>" +
                    this.createdTime +
                    "</td></tr>"
                );
              }
            });

            $("#ReceivedMessages").tablesorter({ theme: "bootstrap" });
            $("#SentMessages").tablesorter({ theme: "bootstrap" });

            var tooltip =
              'Quotes (") match phrases. (not) excludes a match from the results. (or) can be used to do Or searches. I.e. [red or blue] will match either red or blue. Numeric values support >=, >, <=, <, = and != operators.';
            // Initialise Plugin
            var optionsbasic = {
              columnFilters: [
                { columnName: "Adapter instance", inputType: "text" },
                { columnName: "Message type", inputType: "text" },
                { columnName: "Date/Time", inputType: "text" },
              ],
              enableCookies: false,
            };

            //$("#ReceivedMessages").tableFilter(optionsbasic);
            //$("#SentMessages").tableFilter(optionsbasic);
          });
        }

        function loadRemoteDevices() {
          $.ajax({
            url:
              "/api/v1/DevicesView?sort=connectedToInternetTime desc&limit=10&limitToHeadBTAddress=" +
              btAddressOfDevice.replaceAll(":", "%3A"),
          }).then(function (data) {
            const devices = JSON.parse(data);
            $.each(devices, function () {
              if (this.BTAddress != btAddressOfDevice) {
                $("#remoteDevices").append(
                  '<a href="device.html?devicebt=' +
                    this.BTAddress +
                    '">' +
                    this.name +
                    "</a>&nbsp;"
                );
              }
            });
          });
        }

        function setupAddItem() {
          var editDeviceForm = $("#editDeviceForm");
          $("#buttonAddItem").click(function () {
            if (editDeviceForm[0].checkValidity()) {
              var competitionId = $("#competitionInput").val();

              var postItemData = "";
              if (id == null) {
                postItemData = JSON.stringify({
                  competitionId: competitionId,
                });
              } else {
                postItemData = JSON.stringify({
                  btAddress: btAddressOfDevice,
                  competitionId: competitionId,
                });
              }

              $.ajax({
                url: "/api/v1/" + tableName + "/SetCompetition",
                method: "POST",
                data: postItemData,
                dataType: "json",
              }).then(
                function (item) {
                  $("#errorAlert").addClass("collapse");
                  var itemModalElement = document.querySelector("#editdevice");
                  var itemModal =
                    bootstrap.Modal.getOrCreateInstance(itemModalElement);
                  itemModal.hide();
                  $("#itemUpdatedAlert").removeClass("collapse");
                  $("#itemUpdatedAlert").removeClass("collapse");
                  //loadTable();
                },
                function (fail) {
                  $("#errorAlert").text(JSON.stringify(fail));
                  $("#errorAlert").removeClass("collapse");
                }
              );
            } else {
              editDeviceForm[0].classList.add("was-validated");
            }
          });
        }

        function setupDeleteMessageStats() {
          getIsLoggedIn(function (isLoggedIn) {
            if (isLoggedIn) {
              $("#btnDeleteMessageStats").show();
              $("#btnDeleteMessageStats").click(function () {
                $.ajax({
                  url:
                    "/api/v1/Devices/" +
                    btAddressOfDevice +
                    "/MessageStats/DeleteByBTAddress",
                  method: "DELETE",
                  data: null,
                  dataType: "json",
                }).then(
                  function () {
                    loadAggregated();
                    loadMessages();
                  },
                  function (fail) {}
                );
              });
            } else {
              $("#btnDeleteMessageStats").hide();
            }
          });
        }

        $(document).ready(function () {
          $("#nav-placeholder").load("navigation.html", function () {
            $.each($(".navbar").find(".nav-link"), function () {
              console.log($(this).attr("href"));
              console.log(window.location.pathname);
              $(this).toggleClass(
                "active",
                window.location.pathname.indexOf($(this).attr("href")) > -1
              );
            });

            loadAggregated();
            loadMessages();
            loadRemoteDevices();
            //setupAddItem();
            setupDeleteMessageStats();

            getIsLoggedIn(function (isLoggedIn) {
              if (isLoggedIn) {
                $(".edititem").show();
              } else {
                $(".edititem").hide();
              }
            });
          });

          $("#signup-modal-placeholder").load("signupmodal.html", function () {
            $("#signup").on("shown.bs.modal", function () {
              $("#signUpEmailInput").trigger("focus");
            });
          });

          $("#addnewitem-modal-placeholder").load(
            modalHtmlFileName,
            function () {
              $("#editdevice").on("shown.bs.modal", function () {
                $("#descriptionInput").trigger("focus");
              });

              loadDevice();

              var editDeviceForm = $("#editDeviceForm");
              $("#buttonSaveDevice").click(function () {
                if (editDeviceForm[0].checkValidity()) {
                  var description = $("#descriptionInput").val();
                  var btAddress = btAddressOfDevice;
                  $.ajax({
                    url: "/api/v1/Devices",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({
                      BTAddress: btAddress,
                      description: description,
                    }),
                    success: function (response) {
                      $("#editdevice").modal("hide");
                      location.reload();
                    },
                    error: function () {
                      $("#errorAlert").removeClass("collapse");
                    },
                  });

                  var competitionId = $("#competitionInput").val();
                  var postItemData = JSON.stringify({
                    competitionId: competitionId,
                  });

                  $.ajax({
                    url:
                      "/api/v1/" +
                      tableName +
                      "/" +
                      btAddressOfDevice +
                      "/SetCompetition",
                    method: "POST",
                    data: postItemData,
                    dataType: "json",
                  }).then(
                    function (item) {
                      $("#errorAlert").addClass("collapse");
                      var itemModalElement =
                        document.querySelector("#editdevice");
                      var itemModal =
                        bootstrap.Modal.getOrCreateInstance(itemModalElement);
                      itemModal.hide();
                      $("#itemUpdatedAlert").removeClass("collapse");
                      var compName = $("#competitionInput")
                        .find(":selected")
                        .text();
                      $("#competitionName").text(compName);
                      //loadTable();
                    },
                    function (fail) {
                      $("#errorAlert").text(JSON.stringify(fail));
                      $("#errorAlert").removeClass("collapse");
                    }
                  );
                } else {
                  editDeviceForm[0].reportValidity();
                }
              });
            }
          );

          $.ajax({
            url:
              "/api/v1/" + competitionTableName + "?sort=CreatedDate&limit=100",
            dataType: "json",
          }).then(function (items) {
            $.each(items, function () {
              $("#competitionInput").append(
                '<option value="' + this.id + '">' + this.name + "</option>"
              );
            });
          });

          $(document).on("click", ".close", function () {
            $(this).parent().addClass("collapse");
          });
        });
      </script>
    </div>
  </body>
</html>
